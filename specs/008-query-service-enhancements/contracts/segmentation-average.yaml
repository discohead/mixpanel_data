# Segmentation Average API Contract
# Mixpanel Query API: GET /api/query/segmentation/average

endpoint:
  path: /api/query/segmentation/average
  method: GET
  base_url: https://mixpanel.com/api/query

parameters:
  required:
    event:
      type: string
      description: Event name to analyze
      example: "Purchase"

    from_date:
      type: string
      format: date
      description: Start date (YYYY-MM-DD)
      example: "2024-01-01"

    to_date:
      type: string
      format: date
      description: End date (YYYY-MM-DD)
      example: "2024-01-31"

    "on":
      type: string
      description: Numeric property expression to average
      example: 'properties["amount"]'

  optional:
    unit:
      type: string
      enum: ["hour", "day"]
      default: "day"
      description: Time aggregation unit

    where:
      type: string
      description: Filter expression
      example: 'properties["country"] == "US"'

response:
  success:
    status: 200
    content_type: application/json
    schema:
      status:
        type: string
        value: "ok"

      results:
        type: object
        additionalProperties:
          type: number
        description: Average values by date
        example:
          "2024-01-01": 54.32
          "2024-01-02": 62.15

  errors:
    - status: 401
      description: Invalid credentials
      exception: AuthenticationError

    - status: 400
      description: Invalid parameters or non-numeric property
      exception: QueryError

    - status: 429
      description: Rate limit exceeded
      exception: RateLimitError

# Library Method Contract

library_method:
  module: mixpanel_data._internal.services.live_query
  class: LiveQueryService
  method: segmentation_average

  signature: |
    def segmentation_average(
        self,
        event: str,
        from_date: str,
        to_date: str,
        on: str,
        *,
        unit: Literal["hour", "day"] = "day",
        where: str | None = None,
    ) -> NumericAverageResult

  parameters:
    - name: event
      type: str
      required: true
      description: Event name

    - name: from_date
      type: str
      required: true
      description: Start date (YYYY-MM-DD)

    - name: to_date
      type: str
      required: true
      description: End date (YYYY-MM-DD)

    - name: "on"
      type: str
      required: true
      description: Numeric property expression to average

    - name: unit
      type: Literal["hour", "day"]
      required: false
      default: "day"
      description: Time aggregation unit

    - name: where
      type: str | None
      required: false
      default: null
      description: Filter expression

  returns:
    type: NumericAverageResult
    description: Average values per time unit with lazy DataFrame conversion

  raises:
    - AuthenticationError
    - QueryError
    - RateLimitError

api_client_method:
  module: mixpanel_data._internal.api_client
  class: MixpanelAPIClient
  method: segmentation_average

  signature: |
    def segmentation_average(
        self,
        event: str,
        from_date: str,
        to_date: str,
        on: str,
        *,
        unit: str = "day",
        where: str | None = None,
    ) -> dict[str, Any]

  notes:
    - Non-numeric values excluded from average calculation
    - Returns float values for precision
